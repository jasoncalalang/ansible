---
- name: Update system, install OSCAP, generate and run CIS Level 2 remediation script
  hosts: all
  become: yes
  tasks:
    - name: Update all packages to the latest version
      ansible.builtin.dnf:
        name: "*"
        state: latest
    - name: Create a non-root user with sudo privileges
      ansible.builtin.user:
        name: user1
        shell: /bin/bash
        groups: wheel
        # Replace the hash below with one you generate for P@ssw0rd@IBM
        password: "$6$ThiIK8enApAcAI6P$PVAjhaAF9OUPNZx6/8YopsKeWf5V4rpNOTLlNocre2xkDrfvxCHAac/VFoMmi4wiV9IXWa5sh70FEBS/99.ky/"
        state: present
        create_home: yes

    - name: Ensure .ssh directory exists for user1
      ansible.builtin.file:
        path: /home/user1/.ssh
        state: directory
        mode: '0700'
        owner: user1
        group: user1

    - name: Add SSH key to authorized_keys for user1
      ansible.builtin.authorized_key:
        user: user1
        state: present
        key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC0mSLU9Vdy7Dc29yLPL+CDOtLDN4wTdaxbmod7jOZcn7hW8H6z9xHTFba7vJZY/06mhHmexCe6hS8WSUjmGEIU7pqhiL4fRg+JoRL26T23LQS1VM3iKy8pfOM5eSaTL66VlWZFnkyHJH4rpWrjguRgZOAwt4+/v7hE/YiK6Bl9U3XbCTJ5XGsjxtnt3VZLhtr5OBiv1zjMa8dURI3iUZQ8T1e7/AxvyvY28TUfLaCvWoPFgzkA2d44TKj+ZArLikW6ZQgY9PXrt6jl1GhU03w+vIYEr2w8yNPuVSe8KsRd9szAiCWFEPQgV/i8hjz4DwuO44D5g9bf48Re1BZO2dFb0CzwigtFgkUV4GO5jNKVmqlqBygtww2XxP0L02U6S8J4ShsSV1jllsFYVX6vbM3MhK4P8EqsUuWKrqBBApr/YBIZLjTyTnorHv9X1G+YW6flLsV31LDB+5wkBmL782UzypPACnQMcegnhqMJb8wgM3cLHGRmmvtU8D7MGLNuuDGgCiOiNQx6oOs7wDeSpzcVZFuY5oPTEZRtzcRYCp8/dSrBjVurUC/NebQFDzdFSUMQnLgZ2EWDL9srL6QnJVtTzTr65qT5wLm9CWEoaLGuH41yNVeBWWsBEaLZ2fhPqqUArg0jb6KFh/Izpm7IZmZmb9PZRQ5ZKfmtO7NcEZXXAQ=="

    - name: Install OpenSCAP and SCAP Security Guide
      ansible.builtin.dnf:
        name:
          - openscap-scanner
          - scap-security-guide
        state: present

    # -------------------------------------------------------------------------
    #  AUTHSELECT TASKS: ensure authselect is installed and force the 'sssd' profile
    # -------------------------------------------------------------------------
    - name: Install authselect (if not present)
      ansible.builtin.dnf:
        name: authselect
        state: present

    - name: Force authselect to manage PAM using the 'sssd' profile
      ansible.builtin.command: authselect select sssd --force
      register: result_authselect_select
      changed_when: "'No modifications are required' not in result_authselect_select.stdout"

    - name: Apply authselect changes
      ansible.builtin.command: authselect apply-changes
      when: result_authselect_select.changed
